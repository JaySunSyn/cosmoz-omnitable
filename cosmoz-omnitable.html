<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html"/>
<link rel="import" href="../iron-list/iron-list.html"/>
<link rel="import" href="../iron-icons/iron-icons.html"/>
<link rel="import" href="../iron-icon/iron-icon.html"/>
<link rel="import" href="../iron-label/iron-label.html"/>
<link rel="import" href="../paper-checkbox/paper-checkbox.html"/>
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html"/>
<link rel="import" href="../paper-icon-button/paper-icon-button.html"/>
<link rel="import" href="../paper-item/paper-item.html"/>
<link rel="import" href="../paper-listbox/paper-listbox.html"/>
<link rel="import" href="../cosmoz-grouped-list/cosmoz-grouped-list.html"/>
<link rel="import" href="../cosmoz-web-worker/cosmoz-web-worker.html"/>
<link rel="import" href="../cosmoz-i18next/cosmoz-i18next.html">
<link rel="import" href="../cosmoz-bottom-bar/cosmoz-bottom-bar.html"/>

<link rel="import" href="cosmoz-omnitable-templatizer.html">
<link rel="import" href="cosmoz-omnitable-column.html">
<link rel="import" href="cosmoz-omnitable-item-cell.html">
<link rel="import" href="cosmoz-omnitable-header-cell.html">
<link rel="import" href="cosmoz-omnitable-styles.html">
<link rel="import" href="cosmoz-omnitable-column-amount.html">
<link rel="import" href="cosmoz-omnitable-column-date.html">
<link rel="import" href="cosmoz-omnitable-column-boolean.html">
<link rel="import" href="cosmoz-omnitable-column-number.html">


<!--
`<cosmoz-omnitable>`

@group Cosmoz Elements
@element cosmoz-omnitable
@demo demo/index.html
-->
<dom-module id="cosmoz-omnitable">
	<template>

		<style include="cosmoz-omnitable-styles cosmoz-omnitable-column-amount-styles cosmoz-omnitable-column-number-styles">
			/*
				HACK(pasleq): apply a mixin per column index to allow external styling of the columns.
				This means there is a limit in the number of columns that can be externally styled.
			 */
			.cosmoz-omnitable-column-0 {
				@apply(--cosmoz-omnitable-column-0);
			}

			.cosmoz-omnitable-column-1 {
				@apply(--cosmoz-omnitable-column-1);
			}

			.cosmoz-omnitable-column-2 {
				@apply(--cosmoz-omnitable-column-2);
			}

			.cosmoz-omnitable-column-3 {
				@apply(--cosmoz-omnitable-column-3);
			}

			.cosmoz-omnitable-column-4 {
				@apply(--cosmoz-omnitable-column-4);
			}

			.cosmoz-omnitable-column-5 {
				@apply(--cosmoz-omnitable-column-5);
			}

			.cosmoz-omnitable-column-6 {
				@apply(--cosmoz-omnitable-column-6);
			}

			.cosmoz-omnitable-column-7 {
				@apply(--cosmoz-omnitable-column-7);
			}

			.cosmoz-omnitable-column-8 {
				@apply(--cosmoz-omnitable-column-8);
			}

			.cosmoz-omnitable-column-9 {
				@apply(--cosmoz-omnitable-column-9);
			}

			.cosmoz-omnitable-column-10 {
				@apply(--cosmoz-omnitable-column-10);
			}

		</style>

		<cosmoz-web-worker id="sortWorker" on-cosmoz-web-worker-ready="_onWebWorkerReady">
			<script type="text/worker">
				/*global onmessage, postMessage */
				'use strict';

				var getSortFunc = function (sortOn) {
					if (!sortOn) {
						return;
					}
					return function (a, b) {
						var v1 = a[sortOn],
							v2 = b[sortOn];

						if (v1 === undefined || v2 === undefined) {
							console.warn('missing sort property', a, b, sortOn);
							return 0;
						}



						if (typeof v1 === "number" && typeof v2 === "number") {
							return v1 - v2;
						}

						if (typeof v1 === "string" && typeof v2 === "string") {
							return v1 < v2 ? -1 : 1;
						}

						if (typeof v1 === "boolean" && typeof v2 === "boolean") {
							if (v1 === v2) {
								return 0;
							} else {
								return v1 ? -1 : 1;
							}
						}

						console.warn('unsupported sort', typeof v1, v1, typeof v2, v2);
						return 0;
					};
				};

				onmessage = function (event) {
					var data = event.data.data,
						list,
						sortFunc;

					list = data.data;
					sortFunc = getSortFunc(data.sortOn);

					if (sortFunc === undefined) {
						list.sort();
					} else {
						list.sort(sortFunc);
					}

					if (!!data.reverse) {
						list.reverse();
					}

					postMessage({
						workerRun: event.data.workerRun,
						data: data
					});
				};
			</script>
		</cosmoz-web-worker>

		<div class="mainContainer">
			<div class="header" id="header">
				<div class="selectAllCheckbox" hidden$="[[ !selectionEnabled ]]">
					<paper-checkbox on-change="onAllCheckboxChange" hidden$="[[ _noData ]]">
					</paper-checkbox>
				</div>
				<template is="dom-repeat" items="[[visibleColumns]]" as="column" index-as="columnIndex">
					<cosmoz-omnitable-header-cell class="header-cell" column="{{column}}">
					</cosmoz-omnitable-header-cell>
				</template>
			</div>
			<div class="tableContent" id="tableContent">
				<template is="dom-if" if="[[ _noData ]]">
					<div class="tableContent-empty">
						<iron-icon icon="icons:announcement"></iron-icon>
						<div>
							<h3>[[ _('Working set empty', t) ]]</h3>
							<p>[[ _('No data to display.', t) ]]</p>
						</div>
					</div>
				</template>
				<div class="tableContent-scroller" id="scroller">
					<cosmoz-grouped-list id="groupedList" data="{{ sortedFilteredGroupedItems }}"
						selected-items="{{selectedItems}}" display-empty-groups="[[displayEmptyGroups]]" warm-up="35">
						<cosmoz-grouped-list-template id="warmUpTemplate">
							<template>
								<div style="min-height: 25px;"></div>
							</template>
						</cosmoz-grouped-list-template>
						<cosmoz-grouped-list-template id="itemTemplate">
							<template>
								<div class$="{{_computeItemRowClasses(selected)}}">
									<div class="selectItemCheckbox" hidden$="[[ !selectionEnabled ]]">
										<paper-checkbox checked="{{ selected }}" on-change="_onItemCheckboxChange"></paper-checkbox>
									</div>
									<template is="dom-repeat" items="[[visibleColumns]]" as="column" index-as="columnIndex">
										<cosmoz-omnitable-item-cell class$="{{_computeItemRowCellClasses(column, columnIndex)}}"
											column="{{column}}"
											item="{{item}}"
											selected="{{selected}}"
											expanded="{{expanded}}">
										</cosmoz-omnitable-item-cell>
									</template>
								</div>
							</template>
						</cosmoz-grouped-list-template>
						<cosmoz-grouped-list-template id="groupTemplate">
							<template>
								<div class$="{{_computeGroupRowClasses(folded)}}">
									<div class="selectGroupCheckbox" hidden$="[[ !selectionEnabled ]]">
										<paper-checkbox checked="{{ selected }}" on-change="_onGroupCheckboxChange"></paper-checkbox>
									</div>
									<h3 class="groupRow-label">
										<div><span>{{_currentGroupOnColumn.title}}</span>: &nbsp;</div>
										<cosmoz-omnitable-item-cell class="groupRow-cell"
											column="[[_currentGroupOnColumn]]"
											item="[[item.items.0]]"
											folded="{{folded}}">
										</cosmoz-omnitable-item-cell>
									</h3>
									<div>[[ item.items.length ]]</div>
									<paper-icon-button icon="[[ getFoldIcon(folded) ]]" on-tap="toggleGroup"></paper-icon-button>
								</div>
							</template>
						</cosmoz-grouped-list-template>
					</cosmoz-grouped-list>
				</div>
			</div>
			<div class="footer">
				<div class="footer-controls">
					<div class="footer-control">
						<paper-dropdown-menu no-animation vertical-align="bottom" label="[[_('Sort on', t)]]">
							<paper-listbox class="dropdown-content menu" id="sortOnSelector" on-iron-items-changed="_updateSelectedSortIndex" selected="{{_sortOnSelectorSelected}}">
								<paper-item on-tap="_onSortColumnActivate">
									<div style="white-space: nowrap; font-style: italic;">[[ _('No sorting', t) ]]</div>
								</paper-item>
								</cosmoz-omnitable-sort-list-item>
								<template is="dom-repeat" id="sortColumns" items="[[columns]]" as="column">
									<paper-item on-tap="_onSortColumnActivate" hidden$="[[!column.sortOn]]">
										<span>[[column.title]]</span>&nbsp;<span>[[_getSortDirection(column, sortOn.*)]]</span>
									</paper-item>
								</template>
							</paper-listbox>
						</paper-dropdown-menu>
					</div>
					<div class="footer-control">
						<paper-dropdown-menu no-animation vertical-align="bottom" id="groupOnSelector" label="[[_('Group on', t)]]">
							<paper-listbox class="dropdown-content menu" selected="{{ groupOn }}" attr-for-selected="data-group-on">
								<paper-item data-group-on=""><i style="white-space: nowrap">[[ _('No grouping', t) ]]</i></paper-item>
								<template is="dom-repeat" items="[[columns]]" as="column">
									<paper-item data-group-on$="[[column.groupOn]]" hidden$="[[!column.groupOn]]">[[column.title]]</paper-item>
								</template>
							</paper-listbox>
						</paper-dropdown-menu>
					</div>
				</div>
				<div class="footer-tableStats">
					<span>[[ ngettext('{0} group', '{0} groups', _groupsCount, t) ]]</span>
					<span>[[ ngettext('{0} row', '{0} rows', filteredItems.length, t) ]]</span>
				</div>
				<cosmoz-bottom-bar class="footer-actionBar" match-parent info="[[ selectedItems.length ]]" on-action="onAction" active$="[[ !isEmpty(selectedItems.length) ]]">
					<content id="actions" select="[action]"></content>
				</cosmoz-bottom-bar>
			</div>

		</div>
		<div id="columns">
			<content></content>
		</div>

	</template>
	<script type="text/javascript" src="cosmoz-omnitable.js"></script>
</dom-module>

