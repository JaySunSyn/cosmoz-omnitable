<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html"/>
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html"/>
<link rel="import" href="../iron-list/iron-list.html"/>
<link rel="import" href="../iron-icons/iron-icons.html"/>
<link rel="import" href="../iron-icon/iron-icon.html"/>
<link rel="import" href="../iron-label/iron-label.html"/>
<link rel="import" href="../paper-checkbox/paper-checkbox.html"/>
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html"/>
<link rel="import" href="../paper-icon-button/paper-icon-button.html"/>
<link rel="import" href="../paper-item/paper-item.html"/>
<link rel="import" href="../paper-listbox/paper-listbox.html"/>
<link rel="import" href="../cosmoz-grouped-list/cosmoz-grouped-list.html"/>
<link rel="import" href="../cosmoz-web-worker/cosmoz-web-worker.html"/>
<link rel="import" href="../cosmoz-autocomplete/cosmoz-autocomplete.html"/>
<link rel="import" href="../cosmoz-i18next/cosmoz-i18next.html">
<link rel="import" href="../cosmoz-bottom-bar/cosmoz-bottom-bar.html"/>
<link rel="import" href="../cosmoz-range-selector/cosmoz-range-selector.html"/>

<link rel="import" href="cosmoz-omnitable-column.html">
<link rel="import" href="cosmoz-omnitable-column-amount.html">
<link rel="import" href="cosmoz-omnitable-column-date.html">
<link rel="import" href="cosmoz-omnitable-template.html">
<link rel="import" href="cosmoz-omnitable-cell.html">
<link rel="import" href="cosmoz-omnitable-header.html">
<link rel="import" href="cosmoz-omnitable-style.html">
<!--
`<cosmoz-omnitable>` is an example implementation of grouping for iron-list
with features like group count display and folding

### Usage

    <cosmoz-omnitable data="{{ data }}">
    	<header id="id">Id</header>
		<header id="name">Name</header>
		<header id="amount" render-func="renderMoney">Amount</header>
		<header id="date" type="date" render-func="Cosmoz.formatDate">Date</header>

		<button action on-run="runAction">Hello</button>
    </cosmoz-omnitable>

@group Cosmoz Elements
@element cosmoz-omnitable
@demo demo/index.html
-->

<dom-module id="cosmoz-omnitable">
	<template>

		<style include="cosmoz-omnitable-style iron-flex iron-flex-alignment iron-positioning"></style>

		<cosmoz-web-worker id="sortWorker" on-cosmoz-web-worker-ready="_onWebWorkerReady">
			<script type="text/worker">
				/*global onmessage, postMessage */
				'use strict';

				var getSortFunc = function (sortOn) {
					if (!sortOn) {
						return;
					}
					return function (a, b) {
						var v1 = a[sortOn],
							v2 = b[sortOn];

						if (v1 === undefined || v2 === undefined) {
							console.warn('missing sort property', a, b, sortOn);
							return 0;
						}

						if (typeof v1 === "object" && typeof v2 === "object") {
							// TODO: Handle money
							// return cz.tools.sortObject(v1, v2);
							return 0;
						}
						if (typeof v1 === "number" && typeof v2 === "number") {
							return v1 - v2;
						}
						if (typeof v1 === "string" && typeof v2 === "string") {
							return v1 < v2 ? -1 : 1;
						}

						console.warn('unsupported sort', typeof v1, v1, typeof v2, v2);
						return 0;
					};
				};

				onmessage = function (event) {
					var data = event.data.data,
						list,
						sortFunc;

					list = data.data;
					sortFunc = getSortFunc(data.sortOn);

					if (sortFunc === undefined) {
						list.sort();
					} else {
						list.sort(sortFunc);
					}

					if (!!data.reverse) {
						list.reverse();
					}

					postMessage({
						workerRun: event.data.workerRun,
						data: data
					});
				};
			</script>
		</cosmoz-web-worker>

		<div id="omnitable" class="layout vertical flex">
			<div id="header" class="relative horizontal layout end">
				<div class="row-checkbox" style="padding-bottom: 20px;" hidden$="[[ !selectionEnabled ]]">
					<paper-checkbox id="selectAllCheckbox" on-change="onAllCheckboxChange" hidden$="[[ _noData ]]">
					</paper-checkbox>
				</div>
				<template is="dom-repeat" items="[[columns]]" as="column" index-as="columnIndex">
					<cosmoz-omnitable-header template="{{column.headerTemplate}}" column="{{column}}">
					</cosmoz-omnitable-header>
				</template>
			</div>
			<div id="body" class="flex relative layout vertical">
				<template is="dom-if" if="[[ _noData ]]">
					<div id="emptyDataset" class="fit layout vertical center center-justified">
						<div class="layout horizontal start">
							<iron-icon icon="icons:announcement"></iron-icon>
							<div class="layout vertical">
								<h3>[[ _('Working set empty', t) ]]</h3>
								<p>[[ _('No data to display.', t) ]]</p>
							</div>
						</div>
					</div>
				</template>
				<div id="scroller">
					<cosmoz-grouped-list id="groupedList" class="fit" data="{{ sortedFilteredGroupedItems }}"
						selected-items="{{selectedItems}}">
						<item-template id="itemTemplate">
							<template>
								<div class="layout horizontal center">
									<div class="row-checkbox" hidden$="[[ !selectionEnabled ]]">
										<paper-checkbox checked="{{ selected }}" on-change="onItemCheckboxChange"></paper-checkbox>
									</div>
									<template is="dom-repeat" items="[[ columns ]]" as="column" index-as="columnIndex">
										<cosmoz-omnitable-cell class$="_computeCellClasses(column, columnIndex)"
											template="{{column.dataTemplate}}"
											item="{{item}}"
											selected="{{selected}}"
											expanded="{{expanded}}">
										</cosmoz-omnitable-cell>
									</template>
								</div>
							</template>
						</item-template>
						<item-template id="groupTemplate">
							<template>
								<div class="horizontal layout center group-header">
									<h3 class="flex title">
										<span>[[item.name]]</span>
									</h3>
									<div>[[ item.items.length ]]</div>
								</div>
							</template>
						</item-template>
					</cosmoz-grouped-list>
				</div>
			</div>
		</div>

		<div id="columns">
			<content></content>
		</div>
	</template>
	<script type="text/javascript" src="cosmoz-omnitable.js"></script>
</dom-module>