<script>
(function () {
	'use strict';

	var totalInstances = 0;
	Polymer({

		is: 'cosmoz-omnitable-templatizer',

		behaviors: [
			Polymer.Templatizer
		],

		_templatesInUse: null,

		ready: function () {

			var instanceProps = {};

			instanceProps['item'] = true;

			this._instanceProps = instanceProps;

			this._templatesInUse = [];
		},

		init: function (template, host) {
			this._template = template;
			this._templateHost = host;
			this.dataHost = host;
		},

		_getRootDataHost: function () {
			return this._templateHost;
		},

		_ensureTemplatized: function () {
			if (!this.ctor) {
				this.templatize(this._template);
			}
		},

		_forwardParentProp: function (prop, value) {
			//console.log('_forwardParentProp', prop, value);
			this._templatesInUse.forEach(function (template) {
				template[prop] = value;
			});
		},

		_forwardParentPath: function (path, value) {
			//console.log('_forwardParentPath', path, value);
			this._templatesInUse.forEach(function (template) {
				template.notifyPath(path, value, true);
			});
		},

		createInstance: function () {
			var instance;

			this._ensureTemplatized();

			instance = this.stamp({});

			this._templatesInUse.push(instance);

			totalInstances++;
			return instance;
		},

		releaseInstance: function (instance) {
			var i = 0;
			for (i = 0; i < this._templatesInUse.length ; i+=1) {
				if (this._templatesInUse[i] === instance) {
					this._templatesInUse.splice(i, 1);
					return;
				}
			}

			console.warn('templatizer: no such instance', totalInstances);
		},

		releaseAllInstances: function () {
			this.totalInstances -= this._templatesInUse.length;
			this._templatesInUse = null;
		}

	});
}());
</script>
