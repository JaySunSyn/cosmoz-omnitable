<link rel="import" href="cosmoz-omnitable-column-number-behavior.html">
<link rel="import" href="../cosmoz-behaviors/cosmoz-moneyhelper-behavior.html">

<dom-module id="cosmoz-omnitable-column-amount-styles">
	<template>
		<style>
			.amount-cell {
				text-align: right;
			}

			.amount-header-cell .searchHeaderDropdown {
				@apply --layout-vertical;
				padding: 16px 0px;
			}

			.amount-header-cell .searchHeaderDropdown > paper-input {
				padding: 0px 16px;
			}

			.amount-header-cell .searchHeaderDropdownButtons {
				@apply --layout-horizontal;
				@apply --layout-end-justified;
			}
		</style>
	</template>
</dom-module>

<dom-module id="cosmoz-omnitable-column-amount">
	<template>
		<cosmoz-omnitable-templatizer id="data-templatizer">
			<template>
				<span>
					[[renderAmountWithCurrency(item, valuePath)]]
				</span>
			</template>
		</cosmoz-omnitable-templatizer>

		<cosmoz-omnitable-templatizer id="edit-data-templatizer">
			<template>
				<paper-input no-label-float type="number" on-change="_amountValueChanged"
					value="[[renderAmountValue(item, valuePath)]]">
					<div suffix>[[_getCurrency(item, valuePath)]]</div>
				</paper-input>
			</template>

		<cosmoz-omnitable-templatizer id="header-templatizer">
			<template>
				<paper-dropdown-menu id="searchDropDownMenu" label="{{title}}" placeholder="{{_computeFilterText(filter.*)}}" on-close="_closeSearchDropdownMenu">
					<div class="dropdown-content searchHeaderDropdown">
						<paper-input label="Minimum [[title]]" type="number" value="{{_numberFilter.minValue}}"></paper-input>
						<paper-input label="Maximum [[title]]" type="number" value="{{_numberFilter.maxValue}}"></paper-input>
						<div class="searchHeaderDropdownButtons"><paper-button on-tap="_fireCloseSearchDropdownMenu">OK</paper-button></div>
					</div>
				</paper-dropdown-menu>
			</template>
		</cosmoz-omnitable-templatizer>
	</template>
	<script>
		Polymer({
			is: 'cosmoz-omnitable-column-amount',

			behaviors: [
				Cosmoz.OmnitableColumnNumberBehavior,
				Cosmoz.MoneyHelperBehavior
			],

			_getDefaultWidth: function () {
				return '70px';
			},

			_getDefaultFlex: function () {
				return '1';
			},

			_getDefaultCellClass: function () {
				return 'amount-cell';
			},

			_getDefaultHeaderCellClass: function () {
				return 'amount-header-cell';
			},


			renderAmountWithCurrency: function (item, valuePath) {
				var value = this.get(valuePath, item);
				if (value) {
					return this.renderAmount(value);
				}
			},

			renderAmountValue: function (item, valuePath) {
				var value = this.get(valuePath, item);
				return value.amount;
			},

			_getCurrency: function (item, valuePath) {
				var value = this.get(valuePath, item);
				return value && value.currency;
			},

			_amountValueChanged: function (event) {
				var
					input = event.target,
					value = input.value,
					item = event.model.item,
					amountValue,
					originalValue = this.get(this.valuePath, item),
					newValue;

				amountValue = Number(value);
				newValue = {
					amount: amountValue,
					currency: originalValue.currency
				};
				this.set(this.valuePath, newValue, item);
			},

			getComparableValue: function (item, valuePath) {
				var value = this.get(valuePath, item);
				return typeof(value.amount) === 'number' ? value.amount : null;
			}
		});

	</script>
</dom-module>
