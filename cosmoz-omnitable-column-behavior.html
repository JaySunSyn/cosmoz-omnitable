<script>

	if (typeof Cosmoz === 'undefined') {
		var Cosmoz = {};
	}

	/** @polymerBehavior */
	Cosmoz.OmnitableColumnBehavior = {
		properties: {

			title: {
				type: String
			},

			valuePath: {
				type: String,
				observer: 'valuePathChanged'
			},

			/**
			 * If true, the column will be editable by using an input element for rendering.
			 */
			editable: {
				type: Boolean
			},

			filter: {
				type: Object,
				notify: true
			},

			/**
			 * Whether the column wants a list of all distinct values for the column in `values`
			 */
			bindValues: {
				type: Boolean,
				readOnly: true,
				value: false
			},

			/**
			 * All values for this column.
			 */
			values: {
				type: Array
			},

			sortOn: {
				type: String
			},

			groupOn: {
				type: String
			},

			/**
			 * Used to indicate that an element using this behavior is a column definition that can be used
			 * in cosmoz-omnitable
			 */
			isOmnitableColumn: {
				type: Boolean,
				value: true,
				readOnly: true
			},

			width: {
				type: String,
				value: function () {
					return this._getDefaultWidth();
				}
			},

			flex: {
				type: String,
				value: function () {
					return this._getDefaultFlex();
				}
			},

			cellClass: {
				type: String,
				value: function () {
					return this._getDefaultCellClass();
				}
			},

			headerCellClass: {
				type: String,
				value: function () {
					return this._getDefaultHeaderCellClass();
				}
			},

			priority: {
				type: Number,
				value: 0
			},

			dataTemplate: {
				type: Object,
				observer: '_dataTemplateChanged'
			}
		},

		_dataTemplatizer: null,

		_headerTemplatizer: null,

		ready: function () {
			this._headerTemplatizer = this._createTemplatizer('template[id="header-template"');
		},

		_createTemplatizer: function (templateElementOrSelector) {
			var
				template,
				templateHost,
				templatizer;

			if (templateElementOrSelector instanceof HTMLTemplateElement) {
				template = templateElementOrSelector;
				templateHost = Polymer.dom(templateElementOrSelector).parentNode;
			} else {
				template = Polymer.dom(this).querySelector(templateElementOrSelector);
				if (template) {
					templateHost = Polymer.dom(this).getOwnerRoot().host;
				} else {
					template = Polymer.dom(this.root).querySelector(templateElementOrSelector);
					templateHost = Polymer.dom(this.root).getOwnerRoot().host;
				}
			}

			templatizer = document.createElement('cosmoz-omnitable-templatizer');
			templatizer.init(template, templateHost);
			return templatizer;
		},

		_dataTemplateChanged: function (dataTemplate) {
			if (dataTemplate !== undefined && dataTemplate !== null) {
				this._dataTemplatizer = this._createTemplatizer(dataTemplate);
			}
		},

		getDataTemplateInstance: function () {
			var selector;
			if (!this._dataTemplatizer) {
				if (this.editable) {
					selector = 'template[id="edit-data-template"]';
				} else {
					selector = 'template[id="data-template"]';
				}
				this._dataTemplatizer = this._createTemplatizer(selector);
			}
			return this._dataTemplatizer.createInstance();
		},

		getHeaderTemplateInstance: function () {
			return this._headerTemplatizer.createInstance();
		},

		/**
		 * Override this in column elements if you need a different default width
		 */
		_getDefaultWidth: function () {
			return '75px';
		},

		_getDefaultFlex: function () {
			return '1';
		},

		_getDefaultCellClass: function () {
			return 'default-cell';
		},

		_getDefaultHeaderCellClass: function () {
			return 'default-header-cell';
		},

		renderDefaultValue: function (item, valuePath) {
			return this.get(valuePath, item);
		},

		valuePathChanged: function (newPath, oldPath) {
			if (newPath === undefined || newPath === null) {
				return;
			}
			if (this.groupOn === oldPath || this.groupOn === undefined) {
				this.set('groupOn', newPath);
			}
			if (this.sortOn === oldPath || this.sortOn === undefined) {
				this.set('sortOn', newPath);
			}
		},

		getComparableValue: function (item, valuePath) {
			return this.get(valuePath, item);
		},

		_valueChanged: function (event) {
			var
				input = event.target,
				value = input.value,
				item = event.model.item;

			this.set(this.valuePath, value, item);
		},

		getFilterFn: function () {
			if (!this.filter) {
				return;
			}
			if (!Array.isArray(this.filter)) {
				return this._applySingleFilter.bind(this, this.filter.toString().toLowerCase());
			}
			if (this.filter.length > 0) {
				var filterArray = this.filter.map(function (element) {
					return element.toString().toLowerCase();
				});
				return this._applyMultiFilter.bind(this, filterArray);
			}
		},

		_applySingleFilter: function (filterString, item) {
			var value = this.get(this.valuePath, item).toString().toLowerCase();
			return value.indexOf(filterString) >= 0;
		},

		_applyMultiFilter: function (filterArray, item) {
			var	value = this.get(this.valuePath, item).toString().toLowerCase();

			return filterArray.some(function (filter) {
				return value.indexOf(filter) >= 0;
			});
		}

	};

</script>
