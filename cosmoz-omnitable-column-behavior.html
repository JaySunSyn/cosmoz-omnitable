<script>

	if (typeof Cosmoz === 'undefined') {
		var Cosmoz = {};
	}

	/**
	 * @polymerBehavior
	 */
	Cosmoz.OmnitableColumnBehavior = {
		properties: {

			title: {
				type: String
			},

			valuePath: {
				type: String
			},

			dataTemplate: {
				type: Object,
				notify: true
			},

			headerTemplate: {
				type: Object,
				notify: true
			},

			/**
			 * If true, the column will be editable by using an input element for rendering.
			 */
			editable: {
				type: Boolean
			},

			filter: {
				type: Object,
				notify: true
			},

			bindValues: {
				type: Boolean,
				value: false
			},

			/**
			 * All values for this column.
			 */
			values: {
				type: Array,
				value: function () {
					return [];
				}
			},

			locale: {
				type: String,
				value: 'en'
			},

			sortOn: {
				type: String
			},

			groupOn: {
				type: String
			},

			/**
			 * Used to indicate that an element using this behavior is a column definition that can be used
			 * in cosmoz-omnitable
			 */
			isOmnitableColumn: {
				type: Boolean,
				value: true,
				readOnly: true
			},

			width: {
				type: String,
				value: function () {
					return this._getDefaultWidth();
				}
			},

			flex: {
				type: String,
				value: function () {
					return this._getDefaultFlex();
				}
			}
		},

		ready: function () {
			this.dataTemplate = this._getDataTemplate();
			this.headerTemplate = this._getHeaderTemplate();
		},

		_getDataTemplate: function () {
			var templateSelector;

			if (this.editable) {
				templateSelector = 'template[id="edit-data-template"]';
			} else {
				templateSelector = 'template[id="data-template"]';
			}

			return this._getTemplate(templateSelector);

		},

		_getHeaderTemplate: function () {
			var selector = 'template[id="header-template"]';
			return this._getTemplate(selector);
		},

		_getTemplate: function (selector) {
			var template = Polymer.dom(this).querySelector(selector);

			if (!template) {
				template = Polymer.dom(this.root).querySelector(selector);
			}

			return template;

		},

		_getDefaultWidth: function () {
			return '75px';
		},

		_getDefaultFlex: function () {
			return '1';
		},

		renderDefaultValue: function (item, valuePath) {
			return this.get(valuePath, item);
		},

		getComparableValue: function (item, valuePath) {
			return this.get(valuePath, item);
		},

		_valueChanged: function (event) {
			var
				input = event.target,
				value = input.value,
				item = event.model.item;

			this.set(this.valuePath, value, item);
		},

		/**
		 * Returns true if the specified item matches this column filter
		 * TODO: implement multiple values filters
		 */
		applyFilter: function (item) {

			if (!this.filter) {
				return true;
			}

			var
				value = this.get(this.valuePath, item).toString().toLowerCase(),
				filter = this.filter.toString().toLowerCase();
			return value.indexOf(filter) >= 0;
		},

		/**
		 * If a column definition uses @apply in its style, then style will be scoped using a class named
		 * 'cosmoz-omnitable-column[-type]-XXX'.
		 * This class needs to be applied to cosmoz-omnitable-cell and cosmoz-omnitable-header if we want column's template instances to be styled correctly.
		 */
		getSpecificStyleScope: function () {
			var
				classes = this.classList,
				i,
				c;
			for (i = 0 ; i < classes.length ; i +=1) {
				c = classes.item(i);
				if (c.indexOf(this.is) === 0) {
					return c;
				}
			}
		}
	};

</script>
