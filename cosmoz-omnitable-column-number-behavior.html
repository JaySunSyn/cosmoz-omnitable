<link rel="import" href="cosmoz-omnitable-column-behavior.html">
<script>


	if (typeof Cosmoz === 'undefined') {
		var Cosmoz = {};
	}

	/**
	 * Common behavior for column that represents numbers. Used by cosmoz-omnitable-column-number and cosmoz-omnitable-column-amount.
	 * @polymerBehavior
	 */
	Cosmoz.OmnitableColumnNumberBehaviorImpl = {

		properties: {
			_numberFilter: {
				type: Object,
				value: function () {
					return {};
				}
			}
		},

		observers: [
			'_numberFilterChanged(_numberFilter.*)',
			'_filterChanged(filter.*)'
		],

		_filterChangedFromInput: false,

		_filterChangedFromAbove: false,

		_numberFilterChanged: function (change) {
			if (this._filterChangedFromAbove) {
				this._filterChangedFromAbove = false;
				return;
			}

			var
				minValue = this._toNumber(change.base.minValue),
				maxValue = this._toNumber(change.base.maxValue);

			this._filterChangedFromInput = true;
			this.set('filter', {
				minValue: minValue,
				maxValue: maxValue
			});
		},

		_toNumber: function (x) {
			var n = Number(x);
			return (x === undefined || x === null || x === '' || Number.isNaN(n)) ?  undefined : n;
		},

		_filterChanged: function (change) {
			if (this._filterChangedFromInput) {
				this._filterChangedFromInput = false;
				return;
			}

			var filter = change.base;

			this._filterChangedFromAbove = true;

			if (filter) {
				this._numberFilter = {
					minValue: filter.minValue,
					maxValue: filter.maxValue
				};
			} else {
				this._numberFilter = {};
			}
		},

		_computeFilterText: function (change) {
			var
				filter = change.base,
				minValue = this.filter.minValue,
				maxValue = this.filter.maxValue,
				minValueType = typeof(minValue),
				maxValueType = typeof(maxValue),
				text;

			if (minValueType === 'number' && maxValueType === 'number') {
				text = 'Min=' + minValue + ', max='+ maxValue;
			} else if (minValueType === 'number') {
				text = 'Min=' + minValue;
			} else if (maxValueType === 'number') {
				text = 'Max=' + maxValue;
			} else {
				text = '';
			}
			return text;

		},

		applyFilter: function (item) {

			var
				value = this.getComparableValue(item, this.valuePath),
				minValue = this.filter.minValue,
				maxValue = this.filter.maxValue,
				minValueType = typeof(minValue),
				maxValueType = typeof(maxValue),
				valid = false;

			if (minValueType === 'number' && maxValueType === 'number') {
				valid = value >= minValue && value <= maxValue;
			} else if (minValueType === 'number') {
				valid = value >= minValue;
			} else if (maxValueType === 'number') {
				valid = value <= maxValue;
			} else {
				valid = true;
			}

			return valid;

		},

		hasFilter: function () {
			return this.filter && (typeof(this.filter.minValue) === 'number' || typeof(this.filter.maxValue) === 'number');
		},

		_fireCloseSearchDropdownMenu: function (event) {
			// We cannot use this.$.searchDropDownMenu because the content
			// of the template is not attached to this column but to a cosmoz-omnitable-header.
			// Instead, fire a bubbling event that will be captured by the search dropdown menu
			event.target.fire('close');
		},

		_closeSearchDropdownMenu: function (event) {
			event.currentTarget.close();
			event.stopPropagation();
		}

	};

	Cosmoz.OmnitableColumnNumberBehavior = [
		Cosmoz.OmnitableColumnBehavior,
		Cosmoz.OmnitableColumnNumberBehaviorImpl
	];

</script>
</dom-module>