<dom-module id="cosmoz-omnitable-item-cell">
	<template>
		<style>
			:host {
				flex: 1 0 auto;
				padding: 0 3px;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

		</style>
		<slot></slot>
	</template>
	<script>
		Polymer({

			is: 'cosmoz-omnitable-item-cell',

			properties: {

				column: {
					type: Object,
					observer: '_columnChanged'
				},

				item: {
					type: Object
				},

				selected: {
					type: Boolean,
					observer: '_selectedChanged'
				},

				expanded: {
					type: Boolean,
					observer: '_expandedChanged'
				},

				folded: {
					type: Boolean,
					observer: '_foldedChanged'
				},

				title: {
					type: String,
					reflectToAttribute: true,
					computed: '_getTitle(column, item)'
				}
			},

			observers: [
				'_itemUpdated(item.*)',
				'_updateColumnWidth(column.width)',
				'_updateColumnFlex(column.flex)'
			],

			// WARN: do not use '_templateInstance' property name, as this will conflict with
			// a property used by Templatizer
			_cellTemplateInstance: null,

			_columnChanged: function (newColumn, oldColumn) {
				if (newColumn) {
					this._updateTemplate(newColumn.getDataTemplateInstance());
				}
			},

			_getTitle: function (column, item) {
				return column.getString(item, column.valuePath);
			},

			_updateTemplate: function (instance) {
				var parent = Polymer.dom(this),
					children = parent.childNodes,
					i;

				// Remove current content
				if (children) {
					for (i = 0 ; i < children.length ; i+=1) {
						parent.removeChild(children[i]);
					}
				}

				if (instance) {
					Polymer.dom(this).appendChild(instance.root);
					// HACK(pasleq): remove column style scope and set style scope from omnitable
					if (!Polymer.Settings.useNativeShadow) {
						Polymer.StyleTransformer.dom(this, this.column.is, false, true);
						Polymer.StyleTransformer.dom(this, 'cosmoz-omnitable', false, false);
					}
					this._cellTemplateInstance = instance;
					this._assignModel();
				} else {
					this._cellTemplateInstance = null;
				}
			},

			_updateColumnWidth: function (width) {
				this.style.flexBasis = width;
			},

			_updateColumnFlex: function (flex) {
				this.style.flexGrow = flex;
			},

			_itemUpdated: function (itemChange) {
				if (this._cellTemplateInstance) {
					if (itemChange.path === 'item') {
						this._cellTemplateInstance.item = itemChange.value;
					} else {
						this._cellTemplateInstance.notifyPath(itemChange.path, itemChange.value);
					}
				}
			},

			_selectedChanged: function (selected, oldValue) {
				if (this._cellTemplateInstance) {
					this._cellTemplateInstance.selected = selected;
				}
			},

			_expandedChanged: function (expanded, oldValue) {
				if (this._cellTemplateInstance) {
					this._cellTemplateInstance.expanded = expanded;
				}
			},

			_foldedChanged: function (folded, oldValue) {
				if (this._cellTemplateInstance) {
					this._cellTemplateInstance.folded = folded;
				}
			},

			_assignModel: function () {
				this._cellTemplateInstance.item = this.item;
				this._cellTemplateInstance.selected = this.selected;
				this._cellTemplateInstance.expanded = this.expanded;
			}

		});
	</script>
</dom-module>
