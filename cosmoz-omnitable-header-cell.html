<link rel="import" href="../iron-flex-layout/iron-flex-layout.html"/>

<dom-module id="cosmoz-omnitable-header-cell">
	<template>
		<style>
			:host {
				flex: 1 0 auto;
				padding: 0 3px;
				white-space: nowrap;
				text-overflow: ellipsis;
				@apply --layout-horizontal;
				@apply --layout-center;
			}
			::slotted(*) {
				@apply --layout-flex;
			}
		</style>
		<slot></slot>
	</template>
	<script>
		Polymer({
			is: 'cosmoz-omnitable-header-cell',
			properties: {

				column: {
					type: Object,
					observer: '_columnChanged'
				}
			},

			// WARN: do not use '_templateInstance' property name, as this will conflict with
			// a property used by Templatizer

			_headerTemplateInstance: null,

			detached: function () {
				if (this.column && this._headerTemplateInstance) {
					this.column.releaseHeaderTemplateInstance(this._headerTemplateInstance);
					this._headerTemplateInstance = null;
				}

				this._updateTemplate(null);
			},

			_columnChanged: function (newColumn, oldColumn) {
				var newTemplateInstance;
				if (oldColumn) {
					if (oldColumn.headerCellClass) {
						this.toggleClass(oldColumn.headerCellClass, false);
					}

					if (this._headerTemplateInstance) {
						oldColumn.releaseHeaderTemplateInstance(this._headerTemplateInstance);
						this._headerTemplateInstance = null;
					}
				}

				if (newColumn) {
					newTemplateInstance = newColumn.getHeaderTemplateInstance();
					if (newColumn.headerCellClass) {
						this.toggleClass(newColumn.headerCellClass, true);
					}
				}

				this._updateTemplate(newTemplateInstance);
			},

			_updateTemplate: function (newTemplateInstance) {
				var parent = Polymer.dom(this),
					children = parent.childNodes,
					i;

				// Remove current content
				if (children) {
					for (i = 0 ; i < children.length ; i+=1) {
						parent.removeChild(children[i]);
					}
				}

				if (newTemplateInstance) {
					Polymer.dom(this).appendChild(newTemplateInstance.root);
					this._headerTemplateInstance = newTemplateInstance;
					// HACK(pasleq): remove column style scope and set style scope from omnitable
					if (!Polymer.Settings.useNativeShadow) {
						Polymer.StyleTransformer.dom(this, this.column.is, false, true);
						Polymer.StyleTransformer.dom(this, 'cosmoz-omnitable', false, false);
					}
				}
			}
		});
	</script>
</dom-module>
